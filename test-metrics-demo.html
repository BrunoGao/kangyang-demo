<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾¹ç¼˜è®¾å¤‡æ€§èƒ½ç›‘æ§æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        .demo-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .demo-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .demo-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .demo-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .demo-card h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .demo-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .demo-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .demo-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .result-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .status-testing { background: #ffc107; }

        .stats-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ åº·å…»AIè¾¹ç¼˜è®¾å¤‡æ€§èƒ½ç›‘æ§æ¼”ç¤º</h1>
            <p>æµ‹è¯•å…¨æ–°çš„GPUã€CPUã€IOã€ç½‘ç»œã€æ¸©åº¦ã€ç£ç›˜ç›‘æ§åŠŸèƒ½</p>
        </div>

        <div class="content">
            <!-- å®æ—¶ç›‘æ§æ¼”ç¤º -->
            <div class="demo-section">
                <h2>ğŸ“Š å®æ—¶æ€§èƒ½ç›‘æ§</h2>
                <div class="demo-grid">
                    <div class="demo-card">
                        <h3>ç³»ç»Ÿæ¦‚è§ˆ</h3>
                        <button class="demo-button" onclick="getSystemMetrics()">è·å–å®æ—¶æŒ‡æ ‡</button>
                        <div class="result-area" id="system-metrics"></div>
                    </div>
                    
                    <div class="demo-card">
                        <h3>è¯¦ç»†ç›‘æ§æ•°æ®</h3>
                        <button class="demo-button" onclick="getDetailedMetrics()">è·å–è¯¦ç»†æ•°æ®</button>
                        <div class="result-area" id="detailed-metrics"></div>
                    </div>

                    <div class="demo-card">
                        <h3>å†å²æ•°æ®</h3>
                        <button class="demo-button" onclick="getHistoryData()">è·å–å†å²æ•°æ®</button>
                        <div class="result-area" id="history-data"></div>
                    </div>
                </div>

                <!-- å®æ—¶æ•°æ®æ˜¾ç¤º -->
                <div class="stats-display" id="stats-display" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="cpu-usage">0%</div>
                        <div class="stat-label">CPUä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="memory-usage">0%</div>
                        <div class="stat-label">å†…å­˜ä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="disk-usage">0%</div>
                        <div class="stat-label">ç£ç›˜ä½¿ç”¨ç‡</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="temperature">N/A</div>
                        <div class="stat-label">ç³»ç»Ÿæ¸©åº¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="network-speed">0 B/s</div>
                        <div class="stat-label">ç½‘ç»œé€Ÿåº¦</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="gpu-usage">N/A</div>
                        <div class="stat-label">GPUä½¿ç”¨ç‡</div>
                    </div>
                </div>
            </div>

            <!-- æ•°æ®ç”Ÿæˆå™¨ -->
            <div class="demo-section">
                <h2>ğŸ”„ æ•°æ®ç”Ÿæˆå™¨</h2>
                <div class="demo-grid">
                    <div class="demo-card">
                        <h3>ç”Ÿæˆæµ‹è¯•æ•°æ®</h3>
                        <button class="demo-button" onclick="generateTestData()">ç”Ÿæˆ10ä¸ªæ•°æ®ç‚¹</button>
                        <button class="demo-button" onclick="startContinuousMonitoring()">å¼€å§‹è¿ç»­ç›‘æ§</button>
                        <button class="demo-button" onclick="stopContinuousMonitoring()">åœæ­¢ç›‘æ§</button>
                        <div class="result-area" id="generation-log"></div>
                    </div>

                    <div class="demo-card">
                        <h3>ç›‘æ§æ§åˆ¶</h3>
                        <div>
                            <label>ç›‘æ§é—´éš”: </label>
                            <select id="monitoring-interval">
                                <option value="1000">1ç§’</option>
                                <option value="3000" selected>3ç§’</option>
                                <option value="5000">5ç§’</option>
                                <option value="10000">10ç§’</option>
                            </select>
                        </div>
                        <br>
                        <div class="result-area" id="monitoring-status">ç›‘æ§çŠ¶æ€: åœæ­¢</div>
                    </div>

                    <div class="demo-card">
                        <h3>å¿«é€Ÿé“¾æ¥</h3>
                        <a href="http://localhost:3000/#/edge-devices" target="_blank" class="demo-button" style="display: inline-block; text-align: center; text-decoration: none;">
                            æ‰“å¼€å›¾è¡¨ç•Œé¢
                        </a>
                        <a href="http://localhost:8084/docs" target="_blank" class="demo-button" style="display: inline-block; text-align: center; text-decoration: none;">
                            APIæ–‡æ¡£
                        </a>
                        <button class="demo-button" onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8084/api';
        let monitoringTimer = null;
        let dataPointCount = 0;

        // å·¥å…·å‡½æ•°
        function formatBytes(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bps) {
            return formatBytes(bps) + '/s';
        }

        function displayResult(elementId, data, className = 'info') {
            const element = document.getElementById(elementId);
            if (typeof data === 'object') {
                element.innerHTML = `<span class="${className}">âœ… æˆåŠŸ:\n${JSON.stringify(data, null, 2)}</span>`;
            } else {
                element.innerHTML = `<span class="${className}">${data}</span>`;
            }
        }

        function displayError(elementId, error) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<span class="error">âŒ é”™è¯¯: ${error}</span>`;
        }

        async function apiCall(url) {
            try {
                const response = await fetch(`${API_BASE}${url}`);
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                throw error;
            }
        }

        // è·å–ç³»ç»ŸæŒ‡æ ‡
        async function getSystemMetrics() {
            try {
                const data = await apiCall('/performance/metrics');
                
                // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                updateStatsDisplay(data.system_metrics);
                
                // æ˜¾ç¤ºæ¦‚è§ˆä¿¡æ¯
                const overview = {
                    timestamp: data.timestamp,
                    cpu_percent: data.system_metrics.cpu.usage_percent,
                    memory_percent: data.system_metrics.memory.virtual.percent,
                    disk_usage: getDiskUsage(data.system_metrics.disk),
                    network_speed: getNetworkSpeed(data.system_metrics.network),
                    temperature: getTemperature(data.system_metrics.temperature),
                    gpu_available: hasGPU(data.system_metrics.gpu)
                };
                
                displayResult('system-metrics', overview);
                document.getElementById('stats-display').style.display = 'grid';
                
            } catch (error) {
                displayError('system-metrics', error.message);
            }
        }

        // è·å–è¯¦ç»†æŒ‡æ ‡
        async function getDetailedMetrics() {
            try {
                const data = await apiCall('/performance/metrics');
                
                const detailed = {
                    cpu_cores: data.system_metrics.cpu.per_core?.length || 0,
                    memory_total: formatBytes(data.system_metrics.memory.virtual.total),
                    disk_partitions: Object.keys(data.system_metrics.disk.usage || {}).length,
                    network_interfaces: Object.keys(data.system_metrics.network.interfaces || {}).length,
                    temperature_sensors: countTemperatureSensors(data.system_metrics.temperature),
                    gpu_count: countGPUs(data.system_metrics.gpu)
                };
                
                displayResult('detailed-metrics', detailed);
                
            } catch (error) {
                displayError('detailed-metrics', error.message);
            }
        }

        // è·å–å†å²æ•°æ®
        async function getHistoryData() {
            try {
                const data = await apiCall('/performance/history?hours=1');
                
                const historyInfo = {
                    total_records: data.statistics.total_records,
                    earliest_record: data.statistics.earliest_record,
                    latest_record: data.statistics.latest_record,
                    data_points: data.history.timestamps.length,
                    time_range: `${data.parameters.hours}å°æ—¶`,
                    records_by_type: data.statistics.records_by_type
                };
                
                displayResult('history-data', historyInfo);
                
            } catch (error) {
                displayError('history-data', error.message);
            }
        }

        // ç”Ÿæˆæµ‹è¯•æ•°æ®
        async function generateTestData() {
            try {
                displayResult('generation-log', 'å¼€å§‹ç”Ÿæˆæµ‹è¯•æ•°æ®...');
                
                for (let i = 1; i <= 10; i++) {
                    const data = await apiCall('/performance/metrics');
                    displayResult('generation-log', `ç”Ÿæˆç¬¬ ${i}/10 ä¸ªæ•°æ®ç‚¹... CPU: ${data.system_metrics.cpu.usage_percent}%`);
                    
                    if (i < 10) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                displayResult('generation-log', 'âœ… 10ä¸ªæµ‹è¯•æ•°æ®ç‚¹ç”Ÿæˆå®Œæˆï¼');
                
            } catch (error) {
                displayError('generation-log', error.message);
            }
        }

        // å¼€å§‹è¿ç»­ç›‘æ§
        function startContinuousMonitoring() {
            if (monitoringTimer) {
                clearInterval(monitoringTimer);
            }
            
            const interval = parseInt(document.getElementById('monitoring-interval').value);
            dataPointCount = 0;
            
            monitoringTimer = setInterval(async () => {
                try {
                    dataPointCount++;
                    await apiCall('/performance/metrics');
                    
                    document.getElementById('monitoring-status').innerHTML = 
                        `<span class="success">ç›‘æ§çŠ¶æ€: è¿è¡Œä¸­ (${dataPointCount}ä¸ªæ•°æ®ç‚¹)</span>`;
                        
                    // åŒæ—¶æ›´æ–°æ˜¾ç¤º
                    getSystemMetrics();
                    
                } catch (error) {
                    document.getElementById('monitoring-status').innerHTML = 
                        `<span class="error">ç›‘æ§é”™è¯¯: ${error.message}</span>`;
                }
            }, interval);
            
            document.getElementById('monitoring-status').innerHTML = 
                `<span class="success">ç›‘æ§çŠ¶æ€: å¯åŠ¨ä¸­...</span>`;
        }

        // åœæ­¢è¿ç»­ç›‘æ§
        function stopContinuousMonitoring() {
            if (monitoringTimer) {
                clearInterval(monitoringTimer);
                monitoringTimer = null;
            }
            
            document.getElementById('monitoring-status').innerHTML = 
                `<span class="info">ç›‘æ§çŠ¶æ€: å·²åœæ­¢ (å…±ç”Ÿæˆ ${dataPointCount} ä¸ªæ•°æ®ç‚¹)</span>`;
        }

        // æµ‹è¯•æ‰€æœ‰API
        async function testAllAPIs() {
            const apis = [
                '/health',
                '/performance/metrics',
                '/performance/history',
                '/algorithms',
                '/cameras',
                '/service/status'
            ];
            
            let results = '=== APIæµ‹è¯•ç»“æœ ===\n\n';
            
            for (const api of apis) {
                try {
                    const startTime = Date.now();
                    const data = await apiCall(api);
                    const endTime = Date.now();
                    
                    results += `âœ… ${api}: æˆåŠŸ (${endTime - startTime}ms)\n`;
                    if (data.success !== undefined) {
                        results += `   çŠ¶æ€: ${data.success ? 'æˆåŠŸ' : 'å¤±è´¥'}\n`;
                    }
                    results += '\n';
                    
                } catch (error) {
                    results += `âŒ ${api}: å¤±è´¥ - ${error.message}\n\n`;
                }
            }
            
            displayResult('generation-log', results);
        }

        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStatsDisplay(metrics) {
            document.getElementById('cpu-usage').textContent = (metrics.cpu.usage_percent || 0) + '%';
            document.getElementById('memory-usage').textContent = Math.round(metrics.memory.virtual.percent || 0) + '%';
            document.getElementById('disk-usage').textContent = getDiskUsage(metrics.disk) + '%';
            document.getElementById('temperature').textContent = getTemperature(metrics.temperature);
            document.getElementById('network-speed').textContent = getNetworkSpeed(metrics.network);
            document.getElementById('gpu-usage').textContent = getGPUUsage(metrics.gpu);
        }

        // è¾…åŠ©å‡½æ•°
        function getDiskUsage(disk) {
            const usage = disk.usage;
            if (!usage) return 0;
            const firstDisk = Object.values(usage)[0];
            return Math.round(firstDisk?.percent || 0);
        }

        function getNetworkSpeed(network) {
            const io = network.io;
            if (!io) return '0 B/s';
            const total = (io.bytes_recv_per_sec || 0) + (io.bytes_sent_per_sec || 0);
            return formatSpeed(total);
        }

        function getTemperature(temperature) {
            if (!temperature || temperature.message || temperature.error) return 'N/A';
            
            for (const sensorGroup of Object.values(temperature)) {
                if (Array.isArray(sensorGroup)) {
                    for (const sensor of sensorGroup) {
                        if (sensor.current && sensor.current > 0) {
                            return Math.round(sensor.current) + 'Â°C';
                        }
                    }
                }
            }
            return 'N/A';
        }

        function hasGPU(gpu) {
            return gpu && typeof gpu === 'object' && !gpu.message && !gpu.error;
        }

        function getGPUUsage(gpu) {
            if (!hasGPU(gpu)) return 'N/A';
            const firstGPU = Object.values(gpu)[0];
            return (firstGPU?.utilization?.gpu || 0) + '%';
        }

        function countTemperatureSensors(temperature) {
            if (!temperature || temperature.message) return 0;
            let count = 0;
            for (const sensorGroup of Object.values(temperature)) {
                if (Array.isArray(sensorGroup)) {
                    count += sensorGroup.length;
                }
            }
            return count;
        }

        function countGPUs(gpu) {
            if (!hasGPU(gpu)) return 0;
            return Object.keys(gpu).length;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è·å–ä¸€æ¬¡ç³»ç»ŸæŒ‡æ ‡
        window.addEventListener('load', function() {
            setTimeout(() => {
                getSystemMetrics();
            }, 1000);
        });
    </script>
</body>
</html>